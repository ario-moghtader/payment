<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ -Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±09120857529</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', Tahoma, sans-serif; }
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #333; min-height: 100vh; padding: 20px; direction: rtl; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Header */
        header { text-align: center; color: white; margin-bottom: 40px; text-shadow: 0 3px 6px rgba(0,0,0,0.3); }
        h2 { font-size: 2rem; margin-bottom: 10px; }

        /* Stats Cards */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; color: #1e3c72; }
        .stat-label { font-size: 1rem; color: #666; }
        .stat-card.expense { border-bottom: 6px solid #f39c12; }
        
        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-bottom: 30px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: 0.3s; background: transparent; color: white; border: 2px solid transparent; }
        .tab-btn.active { background: white; color: #1e3c72; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .tab-btn:hover:not(.active) { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.5); }

        /* Forms */
        .form-card { background: white; padding: 35px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: none; animation: fadeIn 0.4s ease; margin-bottom: 40px; }
        .form-card.active { display: block; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; color: #444; font-weight: bold; font-size: 1rem; }
        
        /* Inputs with more space */
        .form-input, .form-select, .form-textarea { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 15px; font-size: 1.1rem; transition: 0.3s; background: #fafafa; }
        .form-input:focus { border-color: #2a5298; outline: none; background: white; box-shadow: 0 0 0 4px rgba(42, 82, 152, 0.1); }
        
        /* Date Input Icon */
        .date-input-wrapper { position: relative; }
        .date-input-wrapper::after { content: 'ğŸ“…'; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5; }
        .form-input.date-picker { cursor: pointer; }

        /* Radio Group */
        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .radio-label { flex: 1; text-align: center; padding: 15px; border: 2px solid #eee; border-radius: 15px; cursor: pointer; transition: 0.3s; font-size: 1rem; min-width: 100px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #e8f0fe; border-color: #2a5298; color: #2a5298; font-weight: bold; transform: scale(1.02); }

        /* Buttons */
        .btn-container { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 15px 25px; border: none; border-radius: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: inline-flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: #2a5298; width: 100%; font-size: 1.2rem; }
        .btn-info { background: #3498db; flex: 1; }
        .btn-success { background: #27ae60; flex: 1; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; color: #333; flex: 1; }
        
        /* Filter Section */
        .filter-section { background: rgba(255,255,255,0.15); padding: 25px; border-radius: 20px; margin-top: 40px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .filter-header { color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; font-size: 1.1rem; padding: 10px; border-radius: 10px; transition: 0.3s; }
        .filter-header:hover { background: rgba(255,255,255,0.1); }

        /* List */
        .list-section { margin-top: 30px; }
        .item-card { background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; border-right: 8px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .item-card:hover { transform: translateX(-5px); }
        .item-card.expense { border-color: #f39c12; }
        .item-card.lent { border-color: #27ae60; }
        .item-card.borrowed { border-color: #e74c3c; }
        .item-info { flex: 1; min-width: 200px; }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-start; }
        .item-title { font-weight: bold; font-size: 1.2rem; color: #333; }
        .item-date { font-size: 0.9rem; color: #777; background: #eee; padding: 4px 10px; border-radius: 20px; }
        .item-amount { font-size: 1.4rem; font-weight: bold; color: #2a5298; margin: 10px 0; display: block; }
        .item-actions { display: flex; gap: 10px; }
        .item-actions button { padding: 8px 15px; border-radius: 10px; font-size: 0.9rem; border: none; cursor: pointer; color: white; transition: 0.3s; }
        .item-actions button:hover { opacity: 0.8; }
        
        /* Modal General */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 25px; max-width: 95%; max-height: 90vh; overflow: auto; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        
        /* File Upload */
        .file-box { border: 3px dashed #cbd5e0; padding: 25px; text-align: center; border-radius: 20px; cursor: pointer; margin-bottom: 25px; background: #f8fafc; transition: 0.3s; display: block;}
        .file-box:hover { border-color: #2a5298; background: #edf2f7; }
        .preview-img { max-height: 150px; display: none; margin: 20px auto 0; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* --- CALENDAR STYLES --- */
        .calendar-container { text-align: center; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .calendar-nav-btn { background: #4c6ef5; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .calendar-nav-btn:hover { background: #3b5bdb; transform: scale(1.1); }
        .current-month-display { font-size: 1.3rem; font-weight: bold; color: #2a5298; }
        .weekdays-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; color: #666; margin-bottom: 10px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; transition: 0.2s; font-size: 1.1rem; background: #f8f9fa; }
        .calendar-day:hover { background: #e2e8f0; transform: scale(1.05); }
        .calendar-day.today { border: 2px solid #4c6ef5; color: #4c6ef5; font-weight: bold; }
        .calendar-day.selected { background: #4c6ef5; color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(76, 110, 245, 0.4); }
        .calendar-day.empty { background: transparent; cursor: default; pointer-events: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
    </header>

    <div class="stats-container">
        <div class="stat-card expense">
            <div class="stat-value" id="statTotalExpense">0</div>
            <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø®Ø§Ø±Ø¬ (ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color:#27ae60" id="statTotalLent">0</div>
            <div class="stat-label">Ø·Ù„Ø¨ (Ù‚Ø±Ø¶ Ø¯Ø§Ø¯Ù…)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color:#e74c3c" id="statTotalBorrowed">0</div>
            <div class="stat-label">Ø¨Ø¯Ù‡ÛŒ (Ù‚Ø±Ø¶ Ú¯Ø±ÙØªÙ…)</div>
        </div>
    </div>

    <div class="btn-container">
        <button class="btn btn-warning" onclick="showMonthlyReport()">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
        <button class="btn btn-info" onclick="exportData()">ğŸ’¾ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('expense')">ğŸ›’ Ø«Ø¨Øª Ø®Ø±Ø¬ Ø¬Ø¯ÛŒØ¯</button>
        <button class="tab-btn" onclick="switchTab('debt')">ğŸ¤ Ø«Ø¨Øª Ù‚Ø±Ø¶ / ÙˆØ§Ù…</button>
    </div>

    <div id="expenseForm" class="form-card active">
        <div class="form-group">
            <label class="form-label">Ø¨Ø§Ø¨Øª / Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" id="expDesc" class="form-input" placeholder="Ù…Ø«Ù„Ø§: Ø®Ø±ÛŒØ¯ Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©ØªØŒ Ø¨Ù†Ø²ÛŒÙ†...">
        </div>
        <div class="form-group">
            <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="tel" id="expAmount" class="form-input" placeholder="0" oninput="formatInput(this)">
        </div>
        <div class="form-group">
            <label class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <div class="date-input-wrapper">
                <input type="text" id="expDate" class="form-input date-picker" readonly onclick="openCalendar('expDate')" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <div class="radio-group">
                <label><input type="radio" name="payMethod" value="pos" checked><div class="radio-label">ğŸ’³ Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</div></label>
                <label><input type="radio" name="payMethod" value="card"><div class="radio-label">ğŸ“± Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª</div></label>
                <label><input type="radio" name="payMethod" value="cash"><div class="radio-label">ğŸ’µ Ù†Ù‚Ø¯</div></label>
            </div>
        </div>
        <label class="file-box">
            <span style="font-size: 1.1rem; color: #555;">ğŸ“· Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ ÙÛŒØ´ ÛŒØ§ ÙØ§Ú©ØªÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</span>
            <input type="file" id="expImg" accept="image/*" style="display:none" onchange="previewFile(this)">
            <img id="expPreview" class="preview-img">
        </label>
        <button class="btn btn-primary" onclick="addTransaction('expense')">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
    </div>

    <div id="debtForm" class="form-card">
        <div class="form-group">
            <label class="form-label">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</label>
            <div class="radio-group">
                <label><input type="radio" name="debtType" value="lent" checked><div class="radio-label" style="border-color:#27ae60; color:#27ae60">ğŸŸ¢ Ù‚Ø±Ø¶ Ø¯Ø§Ø¯Ù… (Ø·Ù„Ø¨)</div></label>
                <label><input type="radio" name="debtType" value="borrowed"><div class="radio-label" style="border-color:#e74c3c; color:#e74c3c">ğŸ”´ Ù‚Ø±Ø¶ Ú¯Ø±ÙØªÙ… (Ø¨Ø¯Ù‡ÛŒ)</div></label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Ù†Ø§Ù… Ø´Ø®Øµ / Ø·Ø±Ù Ø­Ø³Ø§Ø¨</label>
            <input type="text" id="debtPerson" class="form-input" placeholder="Ù†Ø§Ù… ÙØ±Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="form-group">
            <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="tel" id="debtAmount" class="form-input" placeholder="0" oninput="formatInput(this)">
        </div>
        <div class="form-group">
            <label class="form-label">ØªØ§Ø±ÛŒØ® Ø¯Ø±ÛŒØ§ÙØª/Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <div class="date-input-wrapper">
                <input type="text" id="debtDate" class="form-input date-picker" readonly onclick="openCalendar('debtDate')" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Ù…ÙˆØ¹Ø¯ Ø¨Ø§Ø²Ú¯Ø´Øª (Ø³Ø±Ø±Ø³ÛŒØ¯)</label>
            <div class="date-input-wrapper">
                <input type="text" id="dueDate" class="form-input date-picker" readonly onclick="openCalendar('dueDate')" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯">
            </div>
        </div>
        <button class="btn btn-primary" onclick="addTransaction('debt')">Ø«Ø¨Øª Ù‚Ø±Ø¶</button>
    </div>

    <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter()">
            <span>ğŸ” ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ù¾ÛŒØ´Ø±ÙØªÙ‡</span>
            <span id="filterArrow">â–¼</span>
        </div>
        <div id="filterOptions" class="filter-grid" style="display: none;">
            <div class="date-input-wrapper">
                <input type="text" id="filterStart" class="form-input date-picker" readonly onclick="openCalendar('filterStart')" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
            </div>
            <div class="date-input-wrapper">
                <input type="text" id="filterEnd" class="form-input date-picker" readonly onclick="openCalendar('filterEnd')" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
            </div>
            <input type="tel" id="filterMin" class="form-input" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <input type="tel" id="filterMax" class="form-input" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <button class="btn btn-success" style="grid-column: 1/-1" onclick="applyFilters()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
            <button class="btn btn-danger" style="grid-column: 1/-1" onclick="resetFilters()">Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
        </div>
    </div>

    <div class="list-section" id="listContainer">
        </div>
</div>

<div id="calendarModal" class="modal" onclick="if(event.target === this) document.getElementById('calendarModal').style.display='none'">
    <div class="modal-content calendar-container">
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changeMonth(-1)">â€¹</button>
            <span class="current-month-display" id="calMonthYear">Ù…Ù‡Ø± 1404</span>
            <button class="calendar-nav-btn" onclick="changeMonth(1)">â€º</button>
        </div>
        <div class="weekdays-row">
            <div>Ø´</div><div>ÛŒ</div><div>Ø¯</div><div>Ø³</div><div>Ú†</div><div>Ù¾</div><div>Ø¬</div>
        </div>
        <div class="days-grid" id="calDaysGrid">
            </div>
        <button class="btn btn-danger" style="margin-top: 20px; width: 100%;" onclick="document.getElementById('calendarModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<div id="reportModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h3 style="text-align:center; margin-bottom:20px;">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø®Ø§Ø±Ø¬ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Ù…Ø§Ù‡</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯</th>
                    <th>Ø¬Ù…Ø¹ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
                </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>
        <button class="btn btn-danger" style="margin-top:25px; width:100%" onclick="document.getElementById('reportModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<div id="imgModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content" style="text-align:center; background: #000; padding: 10px;">
        <img id="modalImageShow" style="max-width:100%; max-height: 80vh; border-radius:10px;">
        <button class="btn btn-danger" style="margin-top:15px; width: 100%;" onclick="document.getElementById('imgModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<script>
    // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ùˆ Ø¹Ø¯Ø¯ ---
    const toEnglishDigits = (str) => str.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    const formatNumber = (num) => new Intl.NumberFormat('fa-IR').format(num);
    const parseFormatted = (str) => parseInt(toEnglishDigits(str).replace(/[^0-9]/g, '')) || 0;

    function formatInput(input) {
        let val = toEnglishDigits(input.value).replace(/[^0-9]/g, '');
        if (val) {
            input.value = parseInt(val).toLocaleString('en-US');
        } else {
            input.value = '';
        }
    }

    // --- Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø¯Ù‚ÛŒÙ‚ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ ---
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        var gy2 = (gm > 2) ? (gy + 1) : gy;
        var days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
        var jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053;
        jy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        var jm, jd;
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); }
        else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        return { year: jy, month: jm, day: jd };
    }
    
    // Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø´Ù…Ø³ÛŒ (0=Ø´Ù†Ø¨Ù‡, 6=Ø¬Ù…Ø¹Ù‡)
    function getJalaliDayOfWeek(jy, jm, jd) {
        // ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø±ÙˆØ² Ù‡ÙØªÙ‡
        // Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨Ø§Ù„Ø§ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² ÛŒÚ© Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ…
        // Ù…Ø¨Ø¯Ø§: 1 ÙØ±ÙˆØ±Ø¯ÛŒÙ† 1402 = Ø³Ù‡ Ø´Ù†Ø¨Ù‡ (3)
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø§Ø² Ù…Ø¨Ø¯Ø§...
        // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ú©Ø¯ Ø§Ø² Ù…ØªØ¯ Date Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… (Ù…Ù…Ú©Ù† Ø§Ø³Øª 1 Ø±ÙˆØ² Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ UI Ú©Ø§ÙÛŒØ³Øª)
        // Ø±ÙˆØ´ Ø¨Ù‡ØªØ±: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù…Ù„ jalaali-js. Ø§Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø¯ Pure JS Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒÙ….
        
        // ÛŒÚ© Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡: ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ -> ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ -> Ú¯Ø±ÙØªÙ† Ø±ÙˆØ² Ù‡ÙØªÙ‡
        // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… jalaliToGregorian (Ù…Ø¹Ú©ÙˆØ³) Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª.
        // Ø¨ÛŒØ§ÛŒÛŒØ¯ Ø§Ø² ÛŒÚ© Ø±ÙˆØ´ Ø´Ù…Ø§Ø±Ø´ Ø±ÙˆØ² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ….
        
        // ÙØ±Ø¶ Ù…ÛŒÚ©Ù†ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± ØªÙ‚ÙˆÛŒÙ… Ø±Ø§ Ø¯Ø±Ø³Øª Ù…ÛŒØ¨ÛŒÙ†Ø¯.
        // Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø§ÙˆÙ„ Ù…Ø§Ù‡:
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø§ÙˆÙ„ Ù…Ø§Ù‡:
        // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Zeller Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø³ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø§Ø³Øª.
        // Ø§Ø² Date Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… Ø¨Ø§ ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚Ø±ÛŒØ¨ÛŒ.
        return new Date(jy + 621, jm - 1, jd).getDay() + 1; // ØªÙ‚Ø±ÛŒØ¨ÛŒ (Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ØµÙ„Ø§Ø­ Ø¯Ø§Ø±Ø¯)
    }
    
    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø±ÙˆØ² Ù‡ÙØªÙ‡)
    function jalaliToGregorian(jy, jm, jd) {
        jy += 1595;
        var days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
        var gy = 400 * ~~(days / 146097);
        days %= 146097;
        if (days > 36524) { days--; gy += 100 * ~~(days / 36524); days %= 36524; if (days >= 365) days++; }
        gy += 4 * ~~(days / 1461);
        days %= 1461;
        if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        var gd = days + 1;
        var gm;
        var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
        return { gy: gy, gm: gm, gd: gd };
    }

    function getDayOfWeek(jy, jm, jd) {
        const gDate = jalaliToGregorian(jy, jm, jd);
        const d = new Date(gDate.gy, gDate.gm - 1, gDate.gd);
        const day = d.getDay(); // 0=Sunday, 6=Saturday
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙØ±Ù…Øª Ø´Ù†Ø¨Ù‡=0 ... Ø¬Ù…Ø¹Ù‡=6
        const map = [1, 2, 3, 4, 5, 6, 0];
        return map[day];
    }

    function getDaysInMonth(year, month) {
        if (month <= 6) return 31;
        if (month <= 11) return 30;
        // Ú©Ø¨ÛŒØ³Ù‡ Ú¯ÛŒØ±ÛŒ Ø³Ø§Ø¯Ù‡:
        const isLeap = (year % 33 % 4 - 1) === 1;
        return isLeap ? 30 : 29;
    }

    // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… ---
    const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
    let calYear, calMonth;
    let targetInputId = ''; // Ú©Ø¯Ø§Ù… Ø§ÛŒÙ†Ù¾ÙˆØª Ù‚Ø±Ø§Ø± Ø§Ø³Øª Ù¾Ø± Ø´ÙˆØ¯

    function openCalendar(inputId) {
        targetInputId = inputId;
        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        
        // Ø§Ú¯Ø± Ø§ÛŒÙ†Ù¾ÙˆØª Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø±Ø¯ØŒ Ø³Ø¹ÛŒ Ú©Ù† Ø¢Ù† Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†
        const currentVal = document.getElementById(inputId).value;
        if (currentVal && currentVal.split('/').length === 3) {
            const parts = currentVal.split('/');
            calYear = parseInt(parts[0]);
            calMonth = parseInt(parts[1]);
        } else {
            calYear = now.year;
            calMonth = now.month;
        }
        
        renderCalendar();
        document.getElementById('calendarModal').style.display = 'flex';
    }

    function changeMonth(dir) {
        calMonth += dir;
        if (calMonth > 12) { calMonth = 1; calYear++; }
        if (calMonth < 1) { calMonth = 12; calYear--; }
        renderCalendar();
    }

    function renderCalendar() {
        document.getElementById('calMonthYear').textContent = `${persianMonths[calMonth - 1]} ${calYear}`;
        const grid = document.getElementById('calDaysGrid');
        grid.innerHTML = '';

        const daysInMonth = getDaysInMonth(calYear, calMonth);
        const firstDayOfWeek = getDayOfWeek(calYear, calMonth, 1);

        // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹ Ù…Ø§Ù‡
        for (let i = 0; i < firstDayOfWeek; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡
        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;
            
            if (calYear === now.year && calMonth === now.month && i === now.day) {
                dayDiv.classList.add('today');
            }

            dayDiv.onclick = () => selectDate(i);
            grid.appendChild(dayDiv);
        }
    }

    function selectDate(day) {
        const monthStr = calMonth < 10 ? '0' + calMonth : calMonth;
        const dayStr = day < 10 ? '0' + day : day;
        const dateStr = `${calYear}/${monthStr}/${dayStr}`;
        
        if (targetInputId) {
            document.getElementById(targetInputId).value = dateStr;
        }
        document.getElementById('calendarModal').style.display = 'none';
        
        // Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± Ø¨ÙˆØ¯ØŒ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†
        if (targetInputId.includes('filter')) {
            // Ø§Ø®ØªÛŒØ§Ø±ÛŒ: applyFilters();
        }
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    let transactions = JSON.parse(localStorage.getItem('acc_data')) || [];

    // Ø³Øª Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    window.onload = function() {
        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        const todayStr = `${now.year}/${(now.month<10?'0':'')+now.month}/${(now.day<10?'0':'')+now.day}`;
        document.getElementById('expDate').value = todayStr;
        document.getElementById('debtDate').value = todayStr;
        applyFilters();
    };

    function toggleFilter() {
        const box = document.getElementById('filterOptions');
        const arrow = document.getElementById('filterArrow');
        if (box.style.display === 'none') {
            box.style.display = 'grid';
            arrow.textContent = 'â–²';
        } else {
            box.style.display = 'none';
            arrow.textContent = 'â–¼';
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.form-card').forEach(f => f.classList.remove('active'));
        if(tab === 'expense') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('expenseForm').classList.add('active');
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('debtForm').classList.add('active');
        }
    }

    function previewFile(input) {
        const preview = input.parentElement.querySelector('.preview-img');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addTransaction(formType) {
        let newItem = { id: Date.now() };
        
        if (formType === 'expense') {
            const desc = document.getElementById('expDesc').value;
            const amount = parseFormatted(document.getElementById('expAmount').value);
            const date = document.getElementById('expDate').value;
            const method = document.querySelector('input[name="payMethod"]:checked').value;
            const imgInput = document.getElementById('expImg');

            if (!desc || amount === 0 || !date) return alert('Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…Ø¨Ù„Øº Ùˆ ØªØ§Ø±ÛŒØ® Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');

            newItem = { ...newItem, type: 'expense', title: desc, amount, date, method };
            
            if(imgInput.files[0]){
                const reader = new FileReader();
                reader.onload = e => {
                    newItem.image = e.target.result;
                    saveAndRender(newItem);
                };
                reader.readAsDataURL(imgInput.files[0]);
                return;
            }

        } else {
            const type = document.querySelector('input[name="debtType"]:checked').value;
            const person = document.getElementById('debtPerson').value;
            const amount = parseFormatted(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value;
            const dueDate = document.getElementById('dueDate').value;

            if (!person || amount === 0 || !date) return alert('Ù†Ø§Ù…ØŒ Ù…Ø¨Ù„Øº Ùˆ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');

            newItem = { ...newItem, type, title: person, amount, date, dueDate };
        }

        saveAndRender(newItem);
    }

    function saveAndRender(item) {
        transactions.unshift(item);
        localStorage.setItem('acc_data', JSON.stringify(transactions));
        
        // Ø±ÛŒØ³Øª ÙØ±Ù…â€ŒÙ‡Ø§
        document.querySelectorAll('input[type="text"], input[type="tel"]').forEach(i => {
            if(!i.classList.contains('date-picker')) i.value = ''; // ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ù†Ú©Ù†ÛŒÙ… Ø¨Ù‡ØªØ± Ø§Ø³Øª
        });
        document.getElementById('expAmount').value = '';
        document.getElementById('debtAmount').value = '';
        document.getElementById('expDesc').value = '';
        document.getElementById('debtPerson').value = '';
        document.getElementById('dueDate').value = '';
        
        document.querySelectorAll('.preview-img').forEach(i => i.style.display = 'none');
        document.getElementById('expImg').value = '';
        
        applyFilters();
        alert('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…');
    }

    function deleteItem(id) {
        if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ğŸ—‘')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('acc_data', JSON.stringify(transactions));
            applyFilters();
        }
    }

    function applyFilters() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        const min = parseFormatted(document.getElementById('filterMin').value);
        const max = parseFormatted(document.getElementById('filterMax').value);

        const filtered = transactions.filter(t => {
            let pass = true;
            if (start && t.date < start) pass = false;
            if (end && t.date > end) pass = false;
            if (min > 0 && t.amount < min) pass = false;
            if (max > 0 && t.amount > max) pass = false;
            return pass;
        });

        renderList(filtered);
    }

    function resetFilters() {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        document.getElementById('filterMin').value = '';
        document.getElementById('filterMax').value = '';
        applyFilters();
    }

    function renderList(list) {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';
        let totalExp = 0, totalLent = 0, totalBorrowed = 0;

        if (list.length === 0) container.innerHTML = '<p style="text-align:center;color:#888; margin-top:30px; font-size:1.2rem;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ğŸ“­</p>';

        list.forEach(t => {
            if(t.type === 'expense') totalExp += t.amount;
            if(t.type === 'lent') totalLent += t.amount;
            if(t.type === 'borrowed') totalBorrowed += t.amount;

            const div = document.createElement('div');
            let itemClass = t.type; 
            let icon = t.type === 'expense' ? 'ğŸ›’' : (t.type === 'lent' ? 'ğŸŸ¢' : 'ğŸ”´');
            let subInfo = t.type === 'expense' 
                ? `<span style="font-size:0.9rem; background:#f0f0f0; padding:4px 8px; border-radius:8px; color:#555;">${t.method === 'pos' ? 'Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†' : t.method === 'card' ? 'Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª' : 'Ù†Ù‚Ø¯'}</span>`
                : `<span style="color:#c0392b; font-size:0.9rem; font-weight:bold;">Ù…ÙˆØ¹Ø¯: ${t.dueDate || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡'}</span>`;

            div.className = `item-card ${itemClass}`;
            div.innerHTML = `
                <div style="font-size:2rem">${icon}</div>
                <div class="item-info">
                    <div class="item-header">
                        <span class="item-title">${t.title}</span>
                        <span class="item-date">${t.date}</span>
                    </div>
                    <span class="item-amount">${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†</span>
                    <div style="margin-top:5px;">${subInfo}</div>
                </div>
                <div class="item-actions">
                    ${t.image ? `<button style="background:#3498db" onclick="showImage('${t.image}')">ğŸ“·</button>` : ''}
                    <button style="background:#e74c3c" onclick="deleteItem(${t.id})">ğŸ—‘</button>
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('statTotalExpense').innerText = formatNumber(totalExp);
        document.getElementById('statTotalLent').innerText = formatNumber(totalLent);
        document.getElementById('statTotalBorrowed').innerText = formatNumber(totalBorrowed);
    }

    function showMonthlyReport() {
        const expenses = transactions.filter(t => t.type === 'expense');
        const report = {};

        expenses.forEach(t => {
            let monthKey = t.date.substring(0, 7); 
            if(!report[monthKey]) report[monthKey] = { count: 0, total: 0 };
            report[monthKey].count++;
            report[monthKey].total += t.amount;
        });

        const sortedMonths = Object.keys(report).sort().reverse();
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = '';
        
        if(sortedMonths.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
        }

        sortedMonths.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td style="direction:ltr; font-weight:bold;">${m}</td>
                    <td>${report[m].count}</td>
                    <td style="color:#2a5298; font-weight:bold">${formatNumber(report[m].total)}</td>
                </tr>
            `;
        });

        document.getElementById('reportModal').style.display = 'flex';
    }

    function showImage(src) {
        document.getElementById('modalImageShow').src = src;
        document.getElementById('imgModal').style.display = 'flex';
    }

    function exportData() {
        const dataStr = JSON.stringify(transactions, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup_${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.json`;
        link.click();
    }
</script>

</body>
</html>
