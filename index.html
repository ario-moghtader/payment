<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', Tahoma, sans-serif; }
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #333; min-height: 100vh; padding: 20px; direction: rtl; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Header */
        header { text-align: center; color: white; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        /* Stats Cards */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #1e3c72; }
        .stat-label { font-size: 0.9rem; color: #666; }
        .stat-card.expense { border-bottom: 4px solid #f39c12; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; background: transparent; color: white; }
        .tab-btn.active { background: white; color: #1e3c72; }

        /* Forms */
        .form-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; animation: fadeIn 0.3s ease; }
        .form-card.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: #444; font-weight: bold; font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; transition: 0.3s; }
        .form-input:focus { border-color: #2a5298; outline: none; }
        
        /* Radio Group */
        .radio-group { display: flex; gap: 10px; }
        .radio-label { flex: 1; text-align: center; padding: 10px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #e8f0fe; border-color: #2a5298; color: #2a5298; font-weight: bold; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: inline-flex; justify-content: center; align-items: center; gap: 5px;}
        .btn-primary { background: #2a5298; }
        .btn-primary:hover { background: #1e3c72; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; color: #333; }
        
        /* Filter Section */
        .filter-section { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-top: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .filter-header { color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        /* List */
        .list-section { margin-top: 20px; }
        .item-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-right: 5px solid #ccc; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .item-card.expense { border-color: #f39c12; }
        .item-card.lent { border-color: #27ae60; }
        .item-card.borrowed { border-color: #e74c3c; }
        .item-info { flex: 1; }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .item-title { font-weight: bold; }
        .item-date { font-size: 0.8rem; color: #888; }
        .item-amount { font-size: 1.1rem; font-weight: bold; color: #2a5298; }
        .item-actions button { padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; border: none; cursor: pointer; color: white; margin-left: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto; width: 500px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table th, .report-table td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        
        /* File Upload */
        .file-box { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 15px; background: #f9f9f9; }
        .preview-img { max-height: 100px; display: none; margin: 10px auto; border-radius: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ</h2>
    </header>

    <div class="stats-container">
        <div class="stat-card expense">
            <div class="stat-value" id="statTotalExpense">0</div>
            <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø®Ø§Ø±Ø¬ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color:#27ae60" id="statTotalLent">0</div>
            <div class="stat-label">Ø·Ù„Ø¨ (Ù‚Ø±Ø¶ Ø¯Ø§Ø¯Ù…)</div>
        </div>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-warning" onclick="showMonthlyReport()">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
        <button class="btn btn-primary" onclick="exportData()">ğŸ’¾ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('expense')">ğŸ›’ Ø«Ø¨Øª Ø®Ø±Ø¬</button>
        <button class="tab-btn" onclick="switchTab('debt')">ğŸ¤ Ø«Ø¨Øª Ù‚Ø±Ø¶</button>
    </div>

    <div id="expenseForm" class="form-card active">
        <div class="form-group">
            <label class="form-label">Ø¨Ø§Ø¨Øª / Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" id="expDesc" class="form-input" placeholder="Ù…Ø«Ù„Ø§: Ø®Ø±ÛŒØ¯ Ú¯ÙˆØ´Øª">
        </div>
        <div class="form-group">
            <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="tel" id="expAmount" class="form-input" placeholder="0" oninput="formatInput(this)">
        </div>
        <div class="form-group">
            <label class="form-label">ØªØ§Ø±ÛŒØ® (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù…Ø±ÙˆØ²)</label>
            <input type="text" id="expDate" class="form-input" placeholder="1404/01/01">
        </div>
        <div class="form-group">
            <div class="radio-group">
                <label><input type="radio" name="payMethod" value="pos" checked><div class="radio-label">Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</div></label>
                <label><input type="radio" name="payMethod" value="card"><div class="radio-label">Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª</div></label>
                <label><input type="radio" name="payMethod" value="cash"><div class="radio-label">Ù†Ù‚Ø¯</div></label>
            </div>
        </div>
        <label class="file-box">
            <span>ğŸ“· Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ ÙÛŒØ´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</span>
            <input type="file" id="expImg" accept="image/*" style="display:none" onchange="previewFile(this)">
            <img id="expPreview" class="preview-img">
        </label>
        <button class="btn btn-primary" onclick="addTransaction('expense')">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
    </div>

    <div id="debtForm" class="form-card">
        <div class="form-group">
            <div class="radio-group">
                <label><input type="radio" name="debtType" value="lent" checked><div class="radio-label" style="color:#27ae60">Ù‚Ø±Ø¶ Ø¯Ø§Ø¯Ù…</div></label>
                <label><input type="radio" name="debtType" value="borrowed"><div class="radio-label" style="color:#e74c3c">Ù‚Ø±Ø¶ Ú¯Ø±ÙØªÙ…</div></label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Ù†Ø§Ù… Ø´Ø®Øµ</label>
            <input type="text" id="debtPerson" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="tel" id="debtAmount" class="form-input" placeholder="0" oninput="formatInput(this)">
        </div>
        <div class="form-group">
            <label class="form-label">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</label>
            <input type="text" id="debtDate" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">Ù…ÙˆØ¹Ø¯ Ø¨Ø§Ø²Ú¯Ø´Øª</label>
            <input type="text" id="dueDate" class="form-input" placeholder="Ù…Ø«Ù„Ø§ 1404/02/01">
        </div>
        <button class="btn btn-primary" onclick="addTransaction('debt')">Ø«Ø¨Øª Ù‚Ø±Ø¶</button>
    </div>

    <div class="filter-section">
        <div class="filter-header" onclick="document.getElementById('filterOptions').style.display = document.getElementById('filterOptions').style.display === 'none' ? 'grid' : 'none'">
            <span>ğŸ” ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ù¾ÛŒØ´Ø±ÙØªÙ‡</span>
            <span>â–¼</span>
        </div>
        <div id="filterOptions" class="filter-grid" style="display: none;">
            <input type="text" id="filterStart" class="form-input" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ® (1404/01/01)">
            <input type="text" id="filterEnd" class="form-input" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
            <input type="tel" id="filterMin" class="form-input" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <input type="tel" id="filterMax" class="form-input" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <button class="btn btn-success" style="grid-column: 1/-1" onclick="applyFilters()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
            <button class="btn btn-danger" style="grid-column: 1/-1" onclick="resetFilters()">Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
        </div>
    </div>

    <div class="list-section" id="listContainer">
        </div>
</div>

<div id="reportModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content">
        <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø®Ø§Ø±Ø¬ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Ù…Ø§Ù‡</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´</th>
                    <th>Ø¬Ù…Ø¹ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
                </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>
        <button class="btn btn-danger" style="margin-top:15px" onclick="document.getElementById('reportModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<div id="imgModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content" style="text-align:center">
        <img id="modalImageShow" style="max-width:100%; border-radius:10px;">
        <button class="btn btn-danger" style="margin-top:10px" onclick="document.getElementById('imgModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<script>
    // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ØªØ§Ø±ÛŒØ® Ùˆ Ø¹Ø¯Ø¯ ---
    const toEnglishDigits = (str) => str.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    const formatNumber = (num) => new Intl.NumberFormat('fa-IR').format(num);
    const parseFormatted = (str) => parseInt(toEnglishDigits(str).replace(/,/g, '')) || 0;

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Ù¾Ø±Ø´ Ù…Ø¨Ù„Øº Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾
    function formatInput(input) {
        let val = toEnglishDigits(input.value).replace(/[^0-9]/g, '');
        if (val) {
            input.value = parseInt(val).toLocaleString('en-US'); // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ú©Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ú¯ Ù…Ø±ÙˆØ±Ú¯Ø±
        } else {
            input.value = '';
        }
    }

    function getToday() {
        // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù…Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø³ØªÛŒ Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ø¯)
        // Ø§ÛŒÙ†Ø¬Ø§ ÛŒÚ© ØªØ§Ø±ÛŒØ® ÙØ±Ø¶ÛŒ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…ØŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ú©Ø§Ø±Ø¨Ø± ØªØ§Ø±ÛŒØ® Ø¯Ù‚ÛŒÙ‚ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
        const d = new Date();
        // ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚Ø±ÛŒØ¨ÛŒ ÛŒØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±.
        // Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒØŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ÛŒØ§ Ø¢Ø®Ø±ÛŒÙ† ØªØ§Ø±ÛŒØ® Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.
        return "1404/01/01"; 
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---
    let transactions = JSON.parse(localStorage.getItem('acc_data')) || [];

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.form-card').forEach(f => f.classList.remove('active'));
        if(tab === 'expense') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('expenseForm').classList.add('active');
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('debtForm').classList.add('active');
        }
    }

    // Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³
    function previewFile(input) {
        const preview = input.parentElement.querySelector('.preview-img');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Ø§ÙØ²ÙˆØ¯Ù† ØªØ±Ø§Ú©Ù†Ø´
    function addTransaction(formType) {
        let newItem = { id: Date.now() };
        
        if (formType === 'expense') {
            const desc = document.getElementById('expDesc').value;
            const amount = parseFormatted(document.getElementById('expAmount').value);
            const date = document.getElementById('expDate').value || getToday();
            const method = document.querySelector('input[name="payMethod"]:checked').value;
            const imgInput = document.getElementById('expImg');

            if (!desc || amount === 0) return alert('Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');

            newItem = { ...newItem, type: 'expense', title: desc, amount, date, method };
            
            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ú©Ø³
            if(imgInput.files[0]){
                const reader = new FileReader();
                reader.onload = e => {
                    newItem.image = e.target.result;
                    saveAndRender(newItem);
                };
                reader.readAsDataURL(imgInput.files[0]);
                return; // ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ø¹Ú©Ø³
            }

        } else {
            const type = document.querySelector('input[name="debtType"]:checked').value;
            const person = document.getElementById('debtPerson').value;
            const amount = parseFormatted(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value || getToday();
            const dueDate = document.getElementById('dueDate').value;

            if (!person || amount === 0) return alert('Ù†Ø§Ù… Ùˆ Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');

            newItem = { ...newItem, type, title: person, amount, date, dueDate };
        }

        saveAndRender(newItem);
    }

    function saveAndRender(item) {
        transactions.unshift(item);
        localStorage.setItem('acc_data', JSON.stringify(transactions));
        resetInputs();
        applyFilters(); // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§
        alert('Ø«Ø¨Øª Ø´Ø¯!');
    }

    function resetInputs() {
        document.querySelectorAll('input[type="text"], input[type="tel"]').forEach(i => i.value = '');
        document.querySelectorAll('.preview-img').forEach(i => i.style.display = 'none');
        // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ² (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    }

    function deleteItem(id) {
        if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('acc_data', JSON.stringify(transactions));
            applyFilters();
        }
    }

    // --- ÙÛŒÙ„ØªØ± Ùˆ Ù†Ù…Ø§ÛŒØ´ ---
    function applyFilters() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        const min = parseFormatted(document.getElementById('filterMin').value);
        const max = parseFormatted(document.getElementById('filterMax').value);

        const filtered = transactions.filter(t => {
            let pass = true;
            // ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® (Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª yyyy/mm/dd Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
            if (start && t.date < start) pass = false;
            if (end && t.date > end) pass = false;
            // ÙÛŒÙ„ØªØ± Ù…Ø¨Ù„Øº
            if (min > 0 && t.amount < min) pass = false;
            if (max > 0 && t.amount > max) pass = false;
            return pass;
        });

        renderList(filtered);
    }

    function resetFilters() {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        document.getElementById('filterMin').value = '';
        document.getElementById('filterMax').value = '';
        applyFilters();
    }

    function renderList(list) {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';
        let totalExp = 0, totalLent = 0;

        if (list.length === 0) container.innerHTML = '<p style="text-align:center;color:#888">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';

        list.forEach(t => {
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ù…Ø¹
            if(t.type === 'expense') totalExp += t.amount;
            if(t.type === 'lent') totalLent += t.amount;

            const div = document.createElement('div');
            let itemClass = t.type; // expense, lent, borrowed
            let icon = t.type === 'expense' ? 'ğŸ›’' : (t.type === 'lent' ? 'ğŸŸ¢' : 'ğŸ”´');
            let subInfo = t.type === 'expense' 
                ? `<span style="font-size:0.8rem; background:#eee; padding:2px 5px; border-radius:4px">${t.method === 'pos' ? 'Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†' : t.method === 'card' ? 'Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª' : 'Ù†Ù‚Ø¯'}</span>`
                : `<span style="color:#c0392b; font-size:0.8rem">Ù…ÙˆØ¹Ø¯: ${t.dueDate || '-'}</span>`;

            div.className = `item-card ${itemClass}`;
            div.innerHTML = `
                <div style="font-size:1.5rem">${icon}</div>
                <div class="item-info">
                    <div class="item-header">
                        <span class="item-title">${t.title}</span>
                        <span class="item-date">${t.date}</span>
                    </div>
                    <div class="item-amount">${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†</div>
                    ${subInfo}
                </div>
                <div class="item-actions">
                    ${t.image ? `<button style="background:#3498db" onclick="showImage('${t.image}')">ğŸ“· Ø¹Ú©Ø³</button>` : ''}
                    <button style="background:#e74c3c" onclick="deleteItem(${t.id})">ğŸ—‘</button>
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('statTotalExpense').innerText = formatNumber(totalExp);
        document.getElementById('statTotalLent').innerText = formatNumber(totalLent);
    }

    // --- Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ ---
    function showMonthlyReport() {
        // ÙÙ‚Ø· Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        const expenses = transactions.filter(t => t.type === 'expense');
        const report = {};

        expenses.forEach(t => {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ® (Ù…Ø«Ø§Ù„: 1404/02/15 -> 1404/02)
            let monthKey = t.date.substring(0, 7); 
            if(!report[monthKey]) report[monthKey] = { count: 0, total: 0 };
            report[monthKey].count++;
            report[monthKey].total += t.amount;
        });

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ (Ù…Ø§Ù‡â€ŒÙ‡Ø§)
        const sortedMonths = Object.keys(report).sort().reverse();

        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = '';
        
        if(sortedMonths.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
        }

        sortedMonths.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td style="direction:ltr">${m}</td>
                    <td>${report[m].count}</td>
                    <td style="color:#2a5298; font-weight:bold">${formatNumber(report[m].total)}</td>
                </tr>
            `;
        });

        document.getElementById('reportModal').style.display = 'flex';
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³
    function showImage(src) {
        document.getElementById('modalImageShow').src = src;
        document.getElementById('imgModal').style.display = 'flex';
    }

    // Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†
    function exportData() {
        const dataStr = JSON.stringify(transactions, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup_${new Date().toLocaleDateString()}.json`;
        link.click();
    }

    // Ø³Øª Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯
    window.onload = function() {
        // ØªØ§Ø¨Ø¹ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø´ØªÙ‡
        // Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª ØµØ¯Ø¯Ø±ØµØ¯ Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªÙˆØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ Ú©Ù‡ Ø¯Ø± Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨ÙˆØ¯
        // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø³ØªÛŒ Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ÛŒØ§ Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¯Ø§Ø±Ø¯ ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        // Ø§Ù…Ø§ Ú†ÙˆÙ† ØªØ§Ø¨Ø¹ gregorianToJalali Ø±Ø§ Ø¯Ø§Ø±Ù…ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
        const now = new Date();
        // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… ØªØ¨Ø¯ÛŒÙ„ (Ú©Ù¾ÛŒ Ø´Ø¯Ù‡ Ø§Ø² Ù‚Ø¨Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ø§Ø±Ú©Ø±Ø¯)
        var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        var gy = now.getFullYear(); var gm = now.getMonth()+1; var gd = now.getDate();
        var gy2 = (gm > 2) ? (gy + 1) : gy;
        var days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
        var jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053; jy += 4 * ~~(days / 1461); days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        var jm, jd;
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); } else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        
        const todayStr = `${jy}/${(jm<10?'0':'')+jm}/${(jd<10?'0':'')+jd}`;
        document.getElementById('expDate').value = todayStr;
        document.getElementById('debtDate').value = todayStr;
        
        applyFilters(); // Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ù„ÛŒØ³Øª
    }

</script>

</body>
</html>
