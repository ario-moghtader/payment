<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ ğŸ’° Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø± 09120857429</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazirmatn', Tahoma, sans-serif; }
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #333; min-height: 100vh; padding: 20px; direction: rtl; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Header & Stats */
        header { text-align: center; color: white; margin-bottom: 40px; text-shadow: 0 3px 6px rgba(0,0,0,0.3); }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: 0.3s; opacity: 0.6; transform: scale(0.95); }
        .stat-card.active-stat { opacity: 1; transform: scale(1); border: 2px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; color: #1e3c72; }
        .stat-label { font-size: 1rem; color: #666; }
        .stat-card.expense { border-bottom: 6px solid #f39c12; }
        .stat-card.lent { border-bottom: 6px solid #27ae60; }
        .stat-card.borrowed { border-bottom: 6px solid #e74c3c; }
        
        /* Tabs */
        .tabs { display: flex; gap: 20px; margin-bottom: 30px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: 0.3s; background: transparent; color: white; border: 2px solid transparent; }
        .tab-btn.active { background: white; color: #1e3c72; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Forms & Common */
        .form-card { background: white; padding: 35px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: none; margin-bottom: 40px; }
        .form-card.active { display: block; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; color: #444; font-weight: bold; }
        .form-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 15px; font-size: 1.1rem; background: #fafafa; }
        .date-input-wrapper { position: relative; }
        .date-input-wrapper::after { content: 'ğŸ“…'; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); opacity: 0.5; pointer-events: none; }
        .form-input.date-picker { cursor: pointer; }

        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .radio-label { flex: 1; text-align: center; padding: 15px; border: 2px solid #eee; border-radius: 15px; cursor: pointer; transition: 0.3s; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;}
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: #e8f0fe; border-color: #2a5298; color: #2a5298; font-weight: bold; }

        .btn-container { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 15px 25px; border: none; border-radius: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-3px); }
        .btn-primary { background: #2a5298; width: 100%; font-size: 1.2rem; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; color: #333; }
        .btn-dark { background: #34495e; }
        .btn-info { background: #3498db; }
        .btn-purple { background: #9b59b6; }

        .filter-section { background: rgba(255,255,255,0.15); padding: 25px; border-radius: 20px; margin-top: 40px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .filter-header { color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .list-section { margin-top: 30px; }
        .item-card { background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; border-right: 8px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .item-card.expense { border-color: #f39c12; }
        .item-card.lent { border-color: #27ae60; }
        .item-card.borrowed { border-color: #e74c3c; }
        .item-info { flex: 1; min-width: 200px; }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .item-title { font-weight: bold; font-size: 1.2rem; }
        .item-date { font-size: 0.9rem; color: #777; background: #eee; padding: 4px 10px; border-radius: 20px; }
        .item-amount { font-size: 1.4rem; font-weight: bold; color: #2a5298; display: block; margin-top: 5px;}
        .list-img { max-width: 120px; max-height: 120px; border-radius: 10px; border: 1px solid #ddd; margin-top: 10px; cursor: pointer; display: block; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 25px; max-width: 95%; max-height: 90vh; overflow: auto; width: 600px; position: relative; }
        
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        
        .report-type-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; background: #f0f0f0; padding: 10px; border-radius: 15px; }
        .report-type-btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; background: transparent; font-weight: bold; transition: 0.3s; }
        .report-type-btn.active { background: white; shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .report-type-btn.active.r-exp { color: #f39c12; border-bottom: 3px solid #f39c12; }
        .report-type-btn.active.r-lent { color: #27ae60; border-bottom: 3px solid #27ae60; }
        .report-type-btn.active.r-borrowed { color: #e74c3c; border-bottom: 3px solid #e74c3c; }

        .detail-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; }
        .detail-img { max-width: 150px; max-height: 150px; border-radius: 10px; border: 1px solid #ddd; margin-top: 10px; cursor: pointer; }
        .detail-no-img { color: #aaa; font-size: 0.8rem; font-style: italic; }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .calendar-nav-btn { background: #4c6ef5; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .current-month-display { font-size: 1.3rem; font-weight: bold; color: #2a5298; }
        .weekdays-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; color: #666; margin-bottom: 10px; text-align: center;}
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-size: 1.1rem; background: #f8f9fa; }
        .calendar-day.today { border: 2px solid #4c6ef5; color: #4c6ef5; font-weight: bold; }
        .calendar-day.empty { background: transparent; cursor: default; }

        .file-box { border: 3px dashed #cbd5e0; padding: 25px; text-align: center; border-radius: 20px; cursor: pointer; margin-bottom: 25px; background: #f8fafc; display: block;}
        .preview-img { max-height: 150px; display: none; margin: 20px auto 0; border-radius: 15px; }

        /* --- PRINT STYLES --- */
        #print-header { display: none; text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        #print-header h2 { margin: 0; font-size: 14pt; direction: ltr; font-weight: bold; color: #000; } 

        @media print {
            @page { margin: 0.5cm; }
            body { background: white; color: black; padding: 0; margin: 0; }
            header, .stats-container, .btn-container, .tabs, .form-card, .filter-section, .item-actions, #filterOptions, .modal:not(#reportModal), .report-type-selector { display: none !important; }
            #print-header { display: block !important; }
            .container { max-width: 100%; padding: 0; margin: 0; width: 100%; }
            .list-section { display: block; margin-top: 0; }
            .list-img, .detail-img { max-width: 250px; max-height: 250px; display: block !important; margin: 10px 0; border: 1px solid #ccc; }
            #reportModal { display: block !important; position: static; background: white; height: auto; z-index: auto; width: 100%; }
            #reportModal .modal-content { box-shadow: none; max-width: 100%; width: 100%; overflow: visible; padding: 0; margin: 0; border: none; }
            #reportModal button { display: none; }
            #reportSummaryView, #reportDetailView { display: none; }
            .print-active { display: block !important; width: 100%; }
            .item-card, .detail-item { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ddd; margin-bottom: 10px; box-shadow: none; border-radius: 10px; padding: 15px; width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<div id="print-header"><h2 id="print-title-text"></h2></div>

<div class="container">
    <header><h2 id="main-title" style="direction: ltr; display: inline-block;"></h2></header>

    <div class="stats-container">
        <div class="stat-card expense" id="cardExpense">
            <div class="stat-value" id="statTotalExpense">0</div>
            <div class="stat-label">Ø¬Ù…Ø¹ Ù…Ø®Ø§Ø±Ø¬ (Ø¯Ø± Ù„ÛŒØ³Øª Ø¬Ø§Ø±ÛŒ)</div>
        </div>
        <div class="stat-card lent" id="cardLent">
            <div class="stat-value" style="color:#27ae60" id="statTotalLent">0</div>
            <div class="stat-label">Ø·Ù„Ø¨ (Ù‚Ø±Ø¶ Ø¯Ø§Ø¯Ù…)</div>
        </div>
        <div class="stat-card borrowed" id="cardBorrowed">
            <div class="stat-value" style="color:#e74c3c" id="statTotalBorrowed">0</div>
            <div class="stat-label">Ø¨Ø¯Ù‡ÛŒ (Ù‚Ø±Ø¶ Ú¯Ø±ÙØªÙ…)</div>
        </div>
    </div>

    <div class="btn-container">
        <button class="btn btn-warning" style="flex: 1;" onclick="openReportModal()">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
        <button class="btn btn-dark" style="flex: 1;" onclick="exportAllData()">ğŸ“¤ Ø¨Ú©Ø§Ù¾ (Backup)</button>
        <button class="btn btn-success" style="flex: 1;" onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©Ø§Ù¾</button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('expense')">ğŸ›’ Ø«Ø¨Øª Ø®Ø±Ø¬ Ø¬Ø¯ÛŒØ¯</button>
        <button class="tab-btn" onclick="switchTab('debt')">ğŸ¤ Ø«Ø¨Øª Ù‚Ø±Ø¶ / ÙˆØ§Ù…</button>
    </div>

    <div id="expenseForm" class="form-card active">
        <div class="form-group"><label class="form-label">Ø¨Ø§Ø¨Øª / Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="expDesc" class="form-input"></div>
        <div class="form-group"><label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input type="tel" id="expAmount" class="form-input" oninput="formatInput(this)"></div>
        <div class="form-group"><label class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</label><div class="date-input-wrapper"><input type="text" id="expDate" class="form-input date-picker" readonly onclick="openCalendar('expDate')"></div></div>
        <div class="form-group">
            <label class="form-label">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <div class="radio-group">
                <label><input type="radio" name="payMethod" value="pos" checked><div class="radio-label">ğŸ’³ Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</div></label>
                <label><input type="radio" name="payMethod" value="card"><div class="radio-label">ğŸ“± Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª</div></label>
                <label><input type="radio" name="payMethod" value="cash"><div class="radio-label">ğŸ’µ Ù†Ù‚Ø¯</div></label>
            </div>
        </div>
        <label class="file-box">
            <span>ğŸ“· Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ ÙÛŒØ´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</span>
            <input type="file" id="expImg" accept="image/*" style="display:none" onchange="previewFile(this)">
            <img id="expPreview" class="preview-img">
        </label>
        <button class="btn btn-primary" onclick="addTransaction('expense')">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
    </div>

    <div id="debtForm" class="form-card">
        <div class="form-group">
            <div class="radio-group">
                <label><input type="radio" name="debtType" value="lent" checked><div class="radio-label" style="border-color:#27ae60; color:#27ae60">ğŸŸ¢ Ø·Ù„Ø¨ (Ø¯Ø§Ø¯Ù…)</div></label>
                <label><input type="radio" name="debtType" value="borrowed"><div class="radio-label" style="border-color:#e74c3c; color:#e74c3c">ğŸ”´ Ø¨Ø¯Ù‡ÛŒ (Ú¯Ø±ÙØªÙ…)</div></label>
            </div>
        </div>
        <div class="form-group"><label class="form-label">Ù†Ø§Ù… Ø·Ø±Ù Ø­Ø³Ø§Ø¨</label><input type="text" id="debtPerson" class="form-input"></div>
        <div class="form-group"><label class="form-label">Ù…Ø¨Ù„Øº</label><input type="tel" id="debtAmount" class="form-input" oninput="formatInput(this)"></div>
        <div class="form-group"><label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="debtDesc" class="form-input" placeholder="Ø¨Ø§Ø¨Øª..."></div>
        <div class="form-group"><label class="form-label">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</label><div class="date-input-wrapper"><input type="text" id="debtDate" class="form-input date-picker" readonly onclick="openCalendar('debtDate')"></div></div>
        <div class="form-group"><label class="form-label">Ù…ÙˆØ¹Ø¯ Ø¨Ø§Ø²Ú¯Ø´Øª</label><div class="date-input-wrapper"><input type="text" id="dueDate" class="form-input date-picker" readonly onclick="openCalendar('dueDate')"></div></div>
        <button class="btn btn-primary" onclick="addTransaction('debt')">Ø«Ø¨Øª Ù‚Ø±Ø¶</button>
    </div>

    <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter()">
            <span id="filterTitle">ğŸ” ÙÛŒÙ„ØªØ± Ù„ÛŒØ³Øª (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ù…Ø±ÙˆØ²)</span>
            <span id="filterArrow">â–¼</span>
        </div>
        <div id="filterOptions" class="filter-grid" style="display: none;">
            <div class="date-input-wrapper"><input type="text" id="filterStart" class="form-input date-picker" readonly onclick="openCalendar('filterStart')" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®"></div>
            <div class="date-input-wrapper"><input type="text" id="filterEnd" class="form-input date-picker" readonly onclick="openCalendar('filterEnd')" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®"></div>
            <input type="tel" id="filterMin" class="form-input" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <input type="tel" id="filterMax" class="form-input" placeholder="Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº" oninput="formatInput(this)">
            <button class="btn btn-success" style="grid-column: 1/-1" onclick="applyFilters()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
            <button class="btn btn-purple" style="grid-column: 1/-1" onclick="showAllTransactions()">Ù†Ù…Ø§ÛŒØ´ Ú©Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            <button class="btn btn-info" style="grid-column: 1/-1; background-color: #6c5ce7;" onclick="printFilteredReport()">ğŸ“„ Ú†Ø§Ù¾/PDF Ù„ÛŒØ³Øª Ø¬Ø§Ø±ÛŒ</button>
        </div>
    </div>

    <div class="list-section" id="listContainer"></div>
</div>

<div id="calendarModal" class="modal" onclick="if(event.target === this) document.getElementById('calendarModal').style.display='none'">
    <div class="modal-content calendar-container" style="text-align: center;">
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changeMonth(-1)">â€¹</button>
            <span class="current-month-display" id="calMonthYear"></span>
            <button class="calendar-nav-btn" onclick="changeMonth(1)">â€º</button>
        </div>
        <div class="weekdays-row"><div>Ø´</div><div>ÛŒ</div><div>Ø¯</div><div>Ø³</div><div>Ú†</div><div>Ù¾</div><div>Ø¬</div></div>
        <div class="days-grid" id="calDaysGrid"></div>
        <button class="btn btn-danger" style="margin-top: 20px; width: 100%;" onclick="document.getElementById('calendarModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<div id="reportModal" class="modal" onclick="if(event.target === this) document.getElementById('reportModal').style.display='none'">
    <div class="modal-content">
        <div id="reportSummaryView" class="print-active">
            <h3 style="text-align:center; margin-bottom:10px;">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
            
            <div class="report-type-selector">
                <button class="report-type-btn r-exp active" onclick="switchReportType('expense')">Ù…Ø®Ø§Ø±Ø¬</button>
                <button class="report-type-btn r-lent" onclick="switchReportType('lent')">Ø·Ù„Ø¨â€ŒÙ‡Ø§ (Ø¯Ø§Ø¯Ù…)</button>
                <button class="report-type-btn r-borrowed" onclick="switchReportType('borrowed')">Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ú¯Ø±ÙØªÙ…)</button>
            </div>

            <table class="report-table">
                <thead><tr><th>Ù…Ø§Ù‡</th><th>ØªØ¹Ø¯Ø§Ø¯</th><th>Ø¬Ù…Ø¹ Ú©Ù„</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                <tbody id="reportTableBody"></tbody>
            </table>
            <button class="btn btn-danger" style="margin-top:25px; width:100%" onclick="document.getElementById('reportModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
        </div>

        <div id="reportDetailView" style="display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
                <h3 id="detailTitle">Ø±ÛŒØ² ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
                <button class="btn btn-dark" style="padding:5px 15px; font-size:0.9rem" onclick="backToSummary()">Ø¨Ø§Ø²Ú¯Ø´Øª â†©ï¸</button>
            </div>
            <div id="detailContainer"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-info" style="flex:1" onclick="printMonthDetails()">ğŸ–¨ï¸ Ú†Ø§Ù¾/PDF Ø§ÛŒÙ† Ù…Ø§Ù‡</button>
                <button class="btn btn-danger" style="flex:1" onclick="document.getElementById('reportModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>
</div>

<div id="imgModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content" style="text-align:center; background: #000; padding: 10px;">
        <img id="modalImageShow" style="max-width:100%; max-height: 80vh; border-radius:10px;">
        <button class="btn btn-danger" style="margin-top:15px; width: 100%;" onclick="document.getElementById('imgModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<script>
    const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
    const toEnglishDigits = (str) => str.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    const formatNumber = (num) => new Intl.NumberFormat('fa-IR').format(num);
    const parseFormatted = (str) => parseInt(toEnglishDigits(str).replace(/[^0-9]/g, '')) || 0;

    function formatInput(input) {
        let val = toEnglishDigits(input.value).replace(/[^0-9]/g, '');
        if (val) input.value = parseInt(val).toLocaleString('en-US');
        else input.value = '';
    }

    // --- Date Logic ---
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        var gy2 = (gm > 2) ? (gy + 1) : gy;
        var days = 355666 + (365 * gy) + ~~((gy2 + 3) / 4) - ~~((gy2 + 99) / 100) + ~~((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
        var jy = -1595 + (33 * ~~(days / 12053));
        days %= 12053; jy += 4 * ~~(days / 1461); days %= 1461;
        if (days > 365) { jy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        var jm, jd;
        if (days < 186) { jm = 1 + ~~(days / 31); jd = 1 + (days % 31); }
        else { jm = 7 + ~~((days - 186) / 30); jd = 1 + ((days - 186) % 30); }
        return { year: jy, month: jm, day: jd };
    }
    
    function getDaysInMonth(year, month) {
        if (month <= 6) return 31;
        if (month <= 11) return 30;
        const isLeap = (year % 33 % 4 - 1) === 1;
        return isLeap ? 30 : 29;
    }

    function jalaliToGregorian(jy, jm, jd) {
        jy += 1595;
        var days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
        var gy = 400 * ~~(days / 146097);
        days %= 146097;
        if (days > 36524) { days--; gy += 100 * ~~(days / 36524); days %= 36524; if (days >= 365) days++; }
        gy += 4 * ~~(days / 1461); days %= 1461;
        if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; }
        var gd = days + 1; var gm;
        var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
        return { gy: gy, gm: gm, gd: gd };
    }

    function getDayOfWeek(jy, jm, jd) {
        const gDate = jalaliToGregorian(jy, jm, jd);
        const d = new Date(gDate.gy, gDate.gm - 1, gDate.gd);
        const map = [1, 2, 3, 4, 5, 6, 0];
        return map[d.getDay()];
    }

    // --- Calendar ---
    let calYear, calMonth, targetInputId = '';

    function openCalendar(inputId) {
        targetInputId = inputId;
        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        const currentVal = document.getElementById(inputId).value;
        if (currentVal && currentVal.split('/').length === 3) {
            const parts = currentVal.split('/');
            calYear = parseInt(parts[0]);
            calMonth = parseInt(parts[1]);
        } else {
            calYear = now.year;
            calMonth = now.month;
        }
        renderCalendar();
        document.getElementById('calendarModal').style.display = 'flex';
    }

    function changeMonth(dir) {
        calMonth += dir;
        if (calMonth > 12) { calMonth = 1; calYear++; }
        if (calMonth < 1) { calMonth = 12; calYear--; }
        renderCalendar();
    }

    function renderCalendar() {
        document.getElementById('calMonthYear').textContent = `${persianMonths[calMonth - 1]} ${calYear}`;
        const grid = document.getElementById('calDaysGrid');
        grid.innerHTML = '';
        const daysInMonth = getDaysInMonth(calYear, calMonth);
        const firstDayOfWeek = getDayOfWeek(calYear, calMonth, 1);
        
        for (let i = 0; i < firstDayOfWeek; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }
        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;
            if (calYear === now.year && calMonth === now.month && i === now.day) dayDiv.classList.add('today');
            dayDiv.onclick = () => selectDate(i);
            grid.appendChild(dayDiv);
        }
    }

    function selectDate(day) {
        const monthStr = calMonth < 10 ? '0' + calMonth : calMonth;
        const dayStr = day < 10 ? '0' + day : day;
        document.getElementById(targetInputId).value = `${calYear}/${monthStr}/${dayStr}`;
        document.getElementById('calendarModal').style.display = 'none';
    }

    // --- Core Application Logic ---
    let transactions = JSON.parse(localStorage.getItem('acc_data')) || [];
    let currentTab = 'expense'; // expense | debt

    function updateHeader() {
        const now = new Date();
        const j = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
        const time = `${now.getHours()}:${(now.getMinutes()<10?'0':'')+now.getMinutes()}`;
        const date = `${j.year}/${(j.month<10?'0':'')+j.month}/${(j.day<10?'0':'')+j.day}`;
        const titleStr = `Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ø´Ø®ØµÛŒ ğŸ’° Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø± 09120857429   ${time}   ${date}`;
        document.getElementById('main-title').innerText = titleStr;
        document.getElementById('print-title-text').innerText = titleStr;
        document.title = titleStr;
    }

    window.onload = function() {
        updateHeader();
        setInterval(updateHeader, 60000);

        const now = gregorianToJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
        const todayStr = `${now.year}/${(now.month<10?'0':'')+now.month}/${(now.day<10?'0':'')+now.day}`;
        
        document.getElementById('expDate').value = todayStr;
        document.getElementById('debtDate').value = todayStr;
        document.getElementById('filterStart').value = todayStr;
        document.getElementById('filterEnd').value = todayStr;
        
        // Initial load
        switchTab('expense');
    };

    function toggleFilter() {
        const box = document.getElementById('filterOptions');
        const arrow = document.getElementById('filterArrow');
        if (box.style.display === 'none') {
            box.style.display = 'grid';
            arrow.textContent = 'â–²';
        } else {
            box.style.display = 'none';
            arrow.textContent = 'â–¼';
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.form-card').forEach(f => f.classList.remove('active'));
        
        // Update Tabs UI
        if(tab === 'expense') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('expenseForm').classList.add('active');
            document.getElementById('filterTitle').innerText = "ğŸ” ÙÛŒÙ„ØªØ± Ù„ÛŒØ³Øª Ù…Ø®Ø§Ø±Ø¬ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ù…Ø±ÙˆØ²)";
            
            // Highlight active stat card
            document.getElementById('cardExpense').classList.add('active-stat');
            document.getElementById('cardLent').classList.remove('active-stat');
            document.getElementById('cardBorrowed').classList.remove('active-stat');
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('debtForm').classList.add('active');
            document.getElementById('filterTitle').innerText = "ğŸ” ÙÛŒÙ„ØªØ± Ù„ÛŒØ³Øª Ù‚Ø±Ø¶â€ŒÙ‡Ø§ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ù…Ø±ÙˆØ²)";
            
            document.getElementById('cardExpense').classList.remove('active-stat');
            document.getElementById('cardLent').classList.add('active-stat');
            document.getElementById('cardBorrowed').classList.add('active-stat');
        }
        
        // Re-apply filter for current tab
        applyFilters();
    }

    function previewFile(input) {
        const preview = input.parentElement.querySelector('.preview-img');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addTransaction(formType) {
        let newItem = { id: Date.now() };
        if (formType === 'expense') {
            const desc = document.getElementById('expDesc').value;
            const amount = parseFormatted(document.getElementById('expAmount').value);
            const date = document.getElementById('expDate').value;
            const method = document.querySelector('input[name="payMethod"]:checked').value;
            const imgInput = document.getElementById('expImg');
            if (!desc || amount === 0 || !date) return alert('Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…Ø¨Ù„Øº Ùˆ ØªØ§Ø±ÛŒØ® Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            newItem = { ...newItem, type: 'expense', title: desc, amount, date, method };
            if(imgInput.files[0]){
                const reader = new FileReader();
                reader.onload = e => { newItem.image = e.target.result; saveAndRender(newItem); };
                reader.readAsDataURL(imgInput.files[0]);
                return;
            }
        } else {
            const type = document.querySelector('input[name="debtType"]:checked').value;
            const person = document.getElementById('debtPerson').value;
            const amount = parseFormatted(document.getElementById('debtAmount').value);
            const desc = document.getElementById('debtDesc').value;
            const date = document.getElementById('debtDate').value;
            const dueDate = document.getElementById('dueDate').value;
            if (!person || amount === 0 || !date) return alert('Ù†Ø§Ù…ØŒ Ù…Ø¨Ù„Øº Ùˆ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            newItem = { ...newItem, type: 'debt', debtType: type, title: person, amount, date, dueDate, desc: desc };
        }
        saveAndRender(newItem);
    }

    function saveAndRender(item) {
        transactions.unshift(item);
        localStorage.setItem('acc_data', JSON.stringify(transactions));
        
        // Clear Inputs
        document.getElementById('expAmount').value = '';
        document.getElementById('debtAmount').value = '';
        document.getElementById('expDesc').value = '';
        document.getElementById('debtPerson').value = '';
        document.getElementById('debtDesc').value = '';
        document.getElementById('dueDate').value = '';
        document.querySelectorAll('.preview-img').forEach(i => i.style.display = 'none');
        document.getElementById('expImg').value = '';
        
        applyFilters();
        alert('Ø«Ø¨Øª Ø´Ø¯ âœ…');
    }

    function deleteItem(id) {
        if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ ğŸ—‘')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('acc_data', JSON.stringify(transactions));
            applyFilters();
        }
    }

    // --- Separate Filter Logic ---
    function applyFilters() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        const min = parseFormatted(document.getElementById('filterMin').value);
        const max = parseFormatted(document.getElementById('filterMax').value);

        const filtered = transactions.filter(t => {
            // First check Tab Type
            if (currentTab === 'expense' && t.type !== 'expense') return false;
            if (currentTab === 'debt' && t.type !== 'debt') return false;

            // Then check Filters
            if (start && t.date < start) return false;
            if (end && t.date > end) return false;
            if (min > 0 && t.amount < min) return false;
            if (max > 0 && t.amount > max) return false;
            return true;
        });
        renderList(filtered);
    }

    function resetFilters() {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        document.getElementById('filterMin').value = '';
        document.getElementById('filterMax').value = '';
        showAllTransactions();
    }

    function showAllTransactions() {
        document.getElementById('filterStart').value = '';
        document.getElementById('filterEnd').value = '';
        applyFilters();
    }

    function renderList(list) {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';
        
        // These totals are for the *current view* (filtered)
        let totalExp = 0, totalLent = 0, totalBorrowed = 0;

        if (list.length === 0) container.innerHTML = '<p style="text-align:center;color:#888; margin-top:20px;">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ğŸ“­</p>';

        list.forEach(t => {
            if(t.type === 'expense') totalExp += t.amount;
            if(t.type === 'debt' && t.debtType === 'lent') totalLent += t.amount;
            if(t.type === 'debt' && t.debtType === 'borrowed') totalBorrowed += t.amount;

            const div = document.createElement('div');
            let itemClass = t.type; 
            let icon, subInfo, descInfo;

            if (t.type === 'expense') {
                icon = 'ğŸ›’';
                let methodLabel = t.method === 'pos' ? 'Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†' : t.method === 'card' ? 'Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª' : 'Ù†Ù‚Ø¯';
                subInfo = `<span style="font-size:0.9rem; background:#f0f0f0; padding:4px 8px; border-radius:8px; color:#555;">${methodLabel}</span>`;
                descInfo = '';
            } else {
                icon = t.debtType === 'lent' ? 'ğŸŸ¢' : 'ğŸ”´';
                itemClass = t.debtType === 'lent' ? 'lent' : 'borrowed';
                subInfo = `<span style="color:#c0392b; font-size:0.9rem; font-weight:bold;">Ù…ÙˆØ¹Ø¯: ${t.dueDate || '---'}</span>`;
                descInfo = t.desc ? `<div style="font-size:0.85rem; color:#666; margin-top:5px;">ØªÙˆØ¶ÛŒØ­Ø§Øª: ${t.desc}</div>` : '';
            }
            
            let imgHtml = t.image ? `<img src="${t.image}" class="list-img" onclick="showImage('${t.image}')">` : '';

            div.className = `item-card ${itemClass}`;
            div.innerHTML = `
                <div style="font-size:2rem">${icon}</div>
                <div class="item-info">
                    <div class="item-header">
                        <span class="item-title">${t.title}</span>
                        <span class="item-date">${t.date}</span>
                    </div>
                    <span class="item-amount">${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†</span>
                    <div style="margin-top:5px;">${subInfo}</div>
                    ${descInfo}
                    ${imgHtml}
                </div>
                <div class="item-actions">
                    <button style="background:#e74c3c" onclick="deleteItem(${t.id})">ğŸ—‘</button>
                </div>
            `;
            container.appendChild(div);
        });

        // Update Stats based on what's visible/tab
        document.getElementById('statTotalExpense').textContent = formatNumber(totalExp);
        document.getElementById('statTotalLent').textContent = formatNumber(totalLent);
        document.getElementById('statTotalBorrowed').textContent = formatNumber(totalBorrowed);
    }

    // --- REPORT LOGIC (UPDATED) ---
    let currentReportType = 'expense';

    function openReportModal() {
        switchReportType('expense'); // Default view
        document.getElementById('reportSummaryView').style.display = 'block';
        document.getElementById('reportDetailView').style.display = 'none';
        document.getElementById('reportSummaryView').classList.add('print-active');
        document.getElementById('reportDetailView').classList.remove('print-active');
        document.getElementById('reportModal').style.display = 'flex';
    }

    function switchReportType(type) {
        currentReportType = type;
        document.querySelectorAll('.report-type-btn').forEach(btn => btn.classList.remove('active'));
        if(type === 'expense') document.querySelector('.r-exp').classList.add('active');
        if(type === 'lent') document.querySelector('.r-lent').classList.add('active');
        if(type === 'borrowed') document.querySelector('.r-borrowed').classList.add('active');
        
        showMonthlyReportTable();
    }

    function showMonthlyReportTable() {
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = ''; 

        // 1. Get ALL data from database (transactions) not just filtered list
        // 2. Filter by selected report type
        let filteredData = [];
        if (currentReportType === 'expense') {
            filteredData = transactions.filter(t => t.type === 'expense');
        } else if (currentReportType === 'lent') {
            filteredData = transactions.filter(t => t.type === 'debt' && t.debtType === 'lent');
        } else if (currentReportType === 'borrowed') {
            filteredData = transactions.filter(t => t.type === 'debt' && t.debtType === 'borrowed');
        }

        const report = {};
        filteredData.forEach(t => {
            let monthKey = t.date.substring(0, 7); 
            if(!report[monthKey]) report[monthKey] = { count: 0, total: 0 };
            report[monthKey].count++;
            report[monthKey].total += t.amount;
        });

        const sortedMonths = Object.keys(report).sort().reverse();
        
        if(sortedMonths.length === 0) tbody.innerHTML = '<tr><td colspan="4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
        
        sortedMonths.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td style="direction:ltr; font-weight:bold;">${m}</td>
                    <td>${report[m].count}</td>
                    <td style="color:#2a5298; font-weight:bold">${formatNumber(report[m].total)}</td>
                    <td><button class="btn btn-info" style="padding:5px 10px; font-size:0.8rem;" onclick="showMonthDetails('${m}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÛŒØ²</button></td>
                </tr>`;
        });
    }

    function showMonthDetails(monthKey) {
        const container = document.getElementById('detailContainer');
        container.innerHTML = '';

        let details = [];
        if (currentReportType === 'expense') {
            details = transactions.filter(t => t.type === 'expense' && t.date.startsWith(monthKey));
        } else if (currentReportType === 'lent') {
            details = transactions.filter(t => t.type === 'debt' && t.debtType === 'lent' && t.date.startsWith(monthKey));
        } else if (currentReportType === 'borrowed') {
            details = transactions.filter(t => t.type === 'debt' && t.debtType === 'borrowed' && t.date.startsWith(monthKey));
        }
        
        details.sort((a,b) => b.date.localeCompare(a.date));
        
        let titleSuffix = currentReportType === 'expense' ? 'Ù…Ø®Ø§Ø±Ø¬' : (currentReportType === 'lent' ? 'Ø·Ù„Ø¨â€ŒÙ‡Ø§' : 'Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§');
        document.getElementById('detailTitle').textContent = `Ø±ÛŒØ² ${titleSuffix}: ${monthKey}`;
        
        if (details.length === 0) container.innerHTML = '<p>Ù…ÙˆØ±Ø¯ÛŒ Ù†ÛŒØ³Øª</p>';
        else {
            details.forEach(t => {
                let subHtml = '';
                if(t.type === 'expense') {
                    const method = t.method === 'pos' ? 'Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†' : t.method === 'card' ? 'Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª' : 'Ù†Ù‚Ø¯';
                    subHtml = `<span style="background:#eee; padding:2px 5px; border-radius:5px; font-size:0.8rem">${method}</span>`;
                } else {
                    subHtml = `<span style="color:#c0392b; font-size:0.8rem">Ø³Ø±Ø±Ø³ÛŒØ¯: ${t.dueDate || '-'}</span>`;
                }

                let extraDesc = t.desc ? `<div style="font-size:0.85rem; color:#666; margin-top:5px;">${t.desc}</div>` : '';
                const imgHtml = t.image ? `<img src="${t.image}" class="detail-img" onclick="showImage('${t.image}')">` : `<div class="detail-no-img">Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³</div>`;
                
                container.innerHTML += `
                    <div class="detail-item">
                        <div class="detail-row">
                            <strong>${t.title}</strong>
                            <span style="color:#777">${t.date}</span>
                        </div>
                        <div class="detail-row">
                            <span style="color:#2a5298; font-weight:bold">${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†</span>
                            ${subHtml}
                        </div>
                        ${extraDesc}
                        ${imgHtml}
                    </div>
                `;
            });
        }

        document.getElementById('reportSummaryView').style.display = 'none';
        document.getElementById('reportDetailView').style.display = 'block';
        document.getElementById('reportSummaryView').classList.remove('print-active');
        document.getElementById('reportDetailView').classList.add('print-active');
    }

    function backToSummary() {
        document.getElementById('reportDetailView').style.display = 'none';
        document.getElementById('reportSummaryView').style.display = 'block';
        document.getElementById('reportDetailView').classList.remove('print-active');
        document.getElementById('reportSummaryView').classList.add('print-active');
    }

    function printFilteredReport() {
        document.getElementById('reportModal').style.display = 'none';
        window.print();
    }

    function printMonthDetails() {
        window.print();
    }

    function exportAllData() {
        const dataStr = JSON.stringify(transactions, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Backup_${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.json`;
        link.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    if(confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ${data.length} Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`)){
                        transactions = data;
                        localStorage.setItem('acc_data', JSON.stringify(transactions));
                        applyFilters(); // Re-apply to show correct list
                        alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.');
                    }
                } else {
                    alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                }
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function showImage(src) {
        document.getElementById('modalImageShow').src = src;
        document.getElementById('imgModal').style.display = 'flex';
    }
</script>

</body>
</html>
